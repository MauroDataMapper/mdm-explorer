<!--
Copyright 2022-2023 University of Oxford
and Health and Social Care Information Centre, also known as NHS Digital

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

SPDX-License-Identifier: Apache-2.0
-->
<div [ngClass]="getClassNames('switchRow')">
  <ng-template #defaultArrowIcon>
    <i [ngClass]="getClassNames('arrowIcon')"></i>
  </ng-template>

  <a
    *ngIf="allowCollapse"
    (click)="toggleCollapse()"
    [ngClass]="getClassNames('arrowIconButton', data.collapsed ? 'collapsed' : null)"
  >
    <ng-container *ngIf="getArrowIconTemplate() as template; else defaultArrowIcon">
      <ng-container
        *ngTemplateOutlet="template; context: getArrowIconContext()"
      ></ng-container>
    </ng-container>
  </a>

  <ng-container *ngIf="getButtonGroupTemplate() as template; else defaultButtonGroup">
    <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
      <ng-container
        *ngTemplateOutlet="template; context: getButtonGroupContext()"
      ></ng-container>
    </div>
  </ng-container>

  <ng-template #defaultButtonGroup>
    <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
      <button
        *ngIf="showAddRuleButton()"
        class="add-rule-button"
        type="button"
        mat-button
        (click)="addRule()"
      >
        <mat-icon>add</mat-icon>
        Rule
      </button>
      <button
        class="add-rule-button"
        type="button"
        mat-button
        *ngIf="addRuleSet"
        (click)="addRuleSet()"
        [disabled]="!hasFields"
      >
        <mat-icon>add_circle_outline</mat-icon>
        Rule Set
      </button>
      <ng-container *ngIf="!!parentValue && allowRuleset">
        <button
          type="button"
          mat-button
          matTooltip="Remove Rule Set"
          *ngIf="removeRuleSet"
          (click)="removeRuleSet()"
          [disabled]="!hasFields"
        >
          <mat-icon>remove_circle_outline</mat-icon>
        </button>
      </ng-container>
    </div>
  </ng-template>

  <ng-container *ngIf="getSwitchGroupTemplate() as template; else defaultSwitchGroup">
    <ng-container
      *ngTemplateOutlet="template; context: getSwitchGroupContext()"
    ></ng-container>
  </ng-container>

  <ng-template #defaultSwitchGroup>
    <mat-radio-group *ngIf="data" [(ngModel)]="data.condition">
      <mat-radio-button color="primary" value="and">AND</mat-radio-button>
      <mat-radio-button *ngIf="showOrRadioButton()" color="primary" value="or"
        >OR</mat-radio-button
      >
    </mat-radio-group>
  </ng-template>
</div>

<div
  #treeContainer
  (transitionend)="transitionEnd($event)"
  [ngClass]="getClassNames('treeContainer', data.collapsed ? 'collapsed' : null)"
>
  <ul [ngClass]="getClassNames('tree')" *ngIf="data && data.rules">
    <ng-container *ngFor="let ruleOrRuleSet of data.rules; let i = index">
      <ng-container *ngLet="extractRule(ruleOrRuleSet) as rule">
        <ng-container *ngLet="extractRuleSet(ruleOrRuleSet) as ruleSet">
          <ng-container
            *ngIf="{
              ruleset: ruleSetExists(ruleSet),
              invalid: isInvalidRuleSet(ruleSet, config)
            } as local"
          >
            <li [ngClass]="getQueryItemClassName(local)">
              <ng-container *ngIf="!local.ruleset">
                <ng-container
                  *ngIf="getRemoveButtonTemplate() as template; else defaultRemoveButton"
                >
                  <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
                    <ng-container
                      *ngTemplateOutlet="template; context: getRemoveButtonContext(rule)"
                    ></ng-container>
                  </div>
                </ng-container>

                <ng-template #defaultRemoveButton>
                  <div [ngClass]="getClassNames('removeButtonSize', 'rightAlign')">
                    <button
                      type="button"
                      [ngClass]="getClassNames('button', 'removeButton')"
                      (click)="removeRule(rule, data)"
                      [disabled]="disabled"
                    >
                      <i [ngClass]="getClassNames('removeIcon')"></i>
                    </button>
                  </div>
                </ng-template>

                <div *ngIf="entities?.length ?? 0 > 0" class="q-inline-block-display">
                  <ng-container
                    *ngIf="getEntityTemplate() as template; else defaultEntity"
                  >
                    <ng-container
                      *ngTemplateOutlet="template; context: getEntityContext(rule)"
                    ></ng-container>
                  </ng-container>
                </div>

                <ng-template #defaultEntity>
                  <div [ngClass]="getClassNames('entityControlSize')">
                    <select
                      [ngClass]="getClassNames('entityControl')"
                      [(ngModel)]="rule.entity"
                      (ngModelChange)="changeEntity($event, rule, i, data)"
                      [disabled]="disabled"
                    >
                      <option *ngFor="let entity of entities" [ngValue]="entity?.value">
                        {{ entity?.name }}
                      </option>
                    </select>
                  </div>
                </ng-template>

                <ng-container *ngIf="getFieldTemplate() as template; else defaultField">
                  <ng-container
                    *ngTemplateOutlet="template; context: getFieldContext(rule)"
                  ></ng-container>
                </ng-container>

                <ng-template #defaultField>
                  <div [ngClass]="getClassNames('fieldControlSize')">
                    <select
                      [ngClass]="getClassNames('fieldControl')"
                      [(ngModel)]="rule.field"
                      (ngModelChange)="changeField($event, rule)"
                      [disabled]="disabled"
                    >
                      <option
                        *ngFor="let field of getFields(rule.entity)"
                        [ngValue]="field.value"
                      >
                        {{ field.name }}
                      </option>
                    </select>
                  </div>
                </ng-template>

                <ng-container
                  *ngIf="getOperatorTemplate() as template; else defaultOperator"
                >
                  <ng-container
                    *ngTemplateOutlet="template; context: getOperatorContext(rule)"
                  ></ng-container>
                </ng-container>

                <ng-template #defaultOperator>
                  <div [ngClass]="getClassNames('operatorControlSize')">
                    <select
                      [ngClass]="getClassNames('operatorControl')"
                      [(ngModel)]="rule.operator"
                      (ngModelChange)="changeOperator(rule)"
                      [disabled]="disabled"
                    >
                      <option
                        *ngFor="let operator of getOperators(rule.field)"
                        [ngValue]="operator"
                      >
                        {{ operator }}
                      </option>
                    </select>
                  </div>
                </ng-template>

                <ng-container
                  *ngIf="findTemplateForRule(rule) as template; else defaultInput"
                >
                  <ng-container
                    *ngTemplateOutlet="template; context: getInputContext(rule)"
                  ></ng-container>
                </ng-container>

                <ng-template #defaultInput>
                  <div
                    [ngClass]="getClassNames('inputControlSize')"
                    [ngSwitch]="getInputType(rule?.field, rule.operator)"
                  >
                    <input
                      [ngClass]="getClassNames('inputControl')"
                      [(ngModel)]="rule.value"
                      (ngModelChange)="changeInput()"
                      [disabled]="disabled"
                      *ngSwitchCase="'string'"
                      type="text"
                    />
                    <input
                      [ngClass]="getClassNames('inputControl')"
                      [(ngModel)]="rule.value"
                      (ngModelChange)="changeInput()"
                      [disabled]="disabled"
                      *ngSwitchCase="'number'"
                      type="number"
                    />
                    <input
                      [ngClass]="getClassNames('inputControl')"
                      [(ngModel)]="rule.value"
                      (ngModelChange)="changeInput()"
                      [disabled]="disabled"
                      *ngSwitchCase="'date'"
                      type="date"
                    />
                    <input
                      [ngClass]="getClassNames('inputControl')"
                      [(ngModel)]="rule.value"
                      (ngModelChange)="changeInput()"
                      [disabled]="disabled"
                      *ngSwitchCase="'time'"
                      type="time"
                    />
                    <select
                      [ngClass]="getClassNames('inputControl')"
                      [(ngModel)]="rule.value"
                      (ngModelChange)="changeInput()"
                      [disabled]="disabled"
                      *ngSwitchCase="'category'"
                    >
                      <option
                        *ngFor="let opt of getOptions(rule.field)"
                        [ngValue]="opt.value"
                      >
                        {{ opt.name }}
                      </option>
                    </select>
                    <ng-container *ngSwitchCase="'multiselect'">
                      <select
                        [ngClass]="getClassNames('inputControl')"
                        [(ngModel)]="rule.value"
                        (ngModelChange)="changeInput()"
                        [disabled]="disabled"
                        multiple
                      >
                        <option
                          *ngFor="let opt of getOptions(rule.field)"
                          [ngValue]="opt.value"
                        >
                          {{ opt.name }}
                        </option>
                      </select>
                    </ng-container>
                    <input
                      [ngClass]="getClassNames('inputControl')"
                      [(ngModel)]="rule.value"
                      (ngModelChange)="changeInput()"
                      [disabled]="disabled"
                      *ngSwitchCase="'boolean'"
                      type="checkbox"
                    />
                  </div>
                </ng-template>
              </ng-container>
              <query-builder
                *ngIf="local.ruleset"
                [data]="ruleSet"
                [disabled]="disabled"
                [parentTouchedCallback]="parentTouchedCallback || onTouchedCallback"
                [parentChangeCallback]="parentChangeCallback || onChangeCallback"
                [parentInputTemplates]="parentInputTemplates || inputTemplates"
                [parentOperatorTemplate]="parentOperatorTemplate || operatorTemplate"
                [parentFieldTemplate]="parentFieldTemplate || fieldTemplate"
                [parentEntityTemplate]="parentEntityTemplate || entityTemplate"
                [parentSwitchGroupTemplate]="
                  parentSwitchGroupTemplate || switchGroupTemplate
                "
                [parentButtonGroupTemplate]="
                  parentButtonGroupTemplate || buttonGroupTemplate
                "
                [parentRemoveButtonTemplate]="
                  parentRemoveButtonTemplate || removeButtonTemplate
                "
                [parentEmptyWarningTemplate]="
                  parentEmptyWarningTemplate || emptyWarningTemplate
                "
                [parentArrowIconTemplate]="parentArrowIconTemplate || arrowIconTemplate"
                [parentValue]="data"
                [classNames]="classNames"
                [config]="config"
                [allowRuleset]="allowRuleset"
                [allowCollapse]="allowCollapse"
                [emptyMessage]="emptyMessage"
                [operatorMap]="operatorMap"
                [rootComponent]="true"
              >
              </query-builder>

              <ng-container
                *ngIf="getEmptyWarningTemplate() as template; else defaultEmptyWarning"
              >
                <ng-container *ngIf="local.invalid">
                  <ng-container
                    *ngTemplateOutlet="template; context: getEmptyWarningContext()"
                  ></ng-container>
                </ng-container>
              </ng-container>

              <ng-template #defaultEmptyWarning>
                <p [ngClass]="getClassNames('emptyWarning')" *ngIf="local.invalid">
                  {{ emptyMessage }}
                </p>
              </ng-template>
            </li>
          </ng-container>
        </ng-container>
      </ng-container>
    </ng-container>
  </ul>
</div>
